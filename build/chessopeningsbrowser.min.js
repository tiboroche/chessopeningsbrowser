/*! chessopeningsbrowser 2022-03-03 */
import{Chessboard,MARKER_TYPE,COLOR}from"./Chessboard.js";const CHESS_COM_URI="https://chess.com/explorer?moveList=",DEFAULT=`
  [Event "Italian"]

1. e4 e5 2. Nf3 Nc6 3. Bc4 Bc5 4. O-O Nf6 {"Giuoco Piano"} *

[Event "Ruy-Lopez"]

1. e4 e5 2. Nf3 Nc6 3. Bb5 a6 4. Ba4 b5 5. Bb3 *
  `,WHITE_LETTERS={K:"k",Q:"q",B:"b",N:"h",R:"r"},BLACK_LETTERS={K:"l",Q:"w",B:"n",N:"j",R:"t"};let currentTree=void 0;const Board=class{constructor(e){this.board=new Chessboard(document.getElementById("board1"),{position:"start"}),this.chess=e}reset(){this.board.removeMarkers(),this.board.setPosition("start")}switch(){this.board.getOrientation()==COLOR.white?this.board.setOrientation(COLOR.black):this.board.setOrientation(COLOR.white)}setPosition(e){this.board.removeMarkers(),this.board.setPosition(e)}markmove(e){this.board.removeMarkers(),this.board.addMarker(e.from,MARKER_TYPE.frame),this.board.addMarker(e.to,MARKER_TYPE.frame)}move(e){var s=this.chess.move(e.san);if(e.chessmove=s,debug("Making move",e.san,this.chess.ascii(),s),s)return this.markmove(s),this.board.movePiece(s.from,s.to);alert("Invalid move !")}destroy(){this.board.destroy()}},Move=class{san;comment;predecessor;openings;successors;chessmove;constructor(e){this.san=e,this.openings=[],this.successors=[]}toString(){return this.san+" ("+this.successors.length+"successors )"}onlysuccessor(){if(1==this.successors.length)return this.successors[0]}},OpeningTree=class{currentMove;startMove;chess;constructor(e,s){this.content=e,this.startMove=new Move(""),this.currentMove=this.startMove,this.chess=new Chess,this.board=new Board(this.chess),this.inittree(this.load()),s&&this.updateuri();e=this.currentMove.onlysuccessor();e?this.makemove(e):this.displaymoves()}load(){let e=[];try{e=pgnParser.parse(this.content)}catch{alert("Invalid PGN file")}return log(`Loaded ${e.length} games.`),e}updateuri(){var e=window.location.origin+window.location.pathname;e+="?content="+LZString.compressToEncodedURIComponent(this.content),window.history.pushState(void 0,"",e)}inittree(e){let i;const o=this.startMove;e.forEach(function(s){for(let e=0;e<s.headers.length;e++){var t=s.headers[e];if("Event"===t.name){i=t.value;break}}let n=o;s.moves.forEach(function(s){let t=!1;for(let e=0;e<n.successors.length;e++){var o=n.successors[e];if(o.san===s.move){n=o,t=!0;break}}if(!t){const r=new Move(s.move);n.successors.push(r),r.predecessor=n,n=r}n.openings.push(i);var e=s.comments;e&&0<e.length&&(n.comment=e[0].text)})})}history(e=this.currentMove){const s=[];let t=e;for(;t.predecessor;)s.unshift(t),t=t.predecessor;return s}santohtml(e,s,t=!1){let o="",r=e.san;s=(s?WHITE_LETTERS:BLACK_LETTERS)[r[0]];return s&&(o+=`<span style="font-family: chessregular;">${s}</span>`,r=r.slice(1)),o+="<b>"+r,t&&(1==e.openings.length?o+=" ["+e.openings.join(",")+"]":o+=" ["+e.openings[0]+" and "+(e.openings.length-1)+" others]"),o+="</b>",e.comment&&(o+=` <i>${e.comment}</i>`),o}showbreadcrumb(t){$("#breadcrumb").empty();var o=$("<p>&nbsp;</p>").appendTo($("#breadcrumb"));for(let s=0;s<t.length;s++){var r=s%2==0;let e="";r&&(e+=s/2+1+"."),e+=` ${this.santohtml(t[s],r)} `,$(`<span role="button">${e}</a>`).appendTo(o).on("click",()=>{this.backtomove(t[s])})}}displaymoves(){var e=this.history();const s=e.length%2==0,t=$("#moves"),r=(this.showbreadcrumb(e),t.empty(),$("#toplay").empty(),(s?$("<p>White to play</p>"):$("<p>Black to play</p>")).appendTo($("#toplay")),"btn btn-small btn-block"),o=(s?"btn-outline-secondary":"btn-outline-dark")+" m-1";var e="btn-secondary m-1",n=$('<div class="btn-group btn-group-sm" role="group" ></div>').appendTo(t);const i=(e,s,t,o)=>{$(`<button class="${r} ${t}">${s}</button>`).appendTo(e).on("click",o)};i(n,"Back",e,()=>{this.backonemove()}),i(n,"Reset",e,()=>{this.resetboard()}),i(n,"Switch",e,()=>{this.switchboard()}),this.currentMove.successors.forEach(e=>{i($("#moves"),this.santohtml(e,s,!0),o,()=>{currentTree.makemove(e)})}),i(t,"See on chess.com","btn-success m-1",()=>{window.open(CHESS_COM_URI+this.history().map(e=>e.san).join("+"),"_blank").focus()})}backonemove(){this.backtomove(this.currentMove.predecessor)}backtomove(e){for(;this.currentMove!=e&&this.currentMove.predecessor;)this.currentMove=this.currentMove.predecessor,this.chess.undo();this.board.setPosition(this.chess.fen()),this.currentMove.chessmove&&this.board.markmove(this.currentMove.chessmove),this.displaymoves()}resetboard(){this.chess.reset(),this.currentMove=this.startMove,this.board.reset(),this.displaymoves()}switchboard(){this.board.switch()}async makemove(e){let s=e;for(;;){await this.board.move(s);var t=s.onlysuccessor();if(!t)break;this.showbreadcrumb(this.history(s)),await sleep(100),s=t}this.currentMove=s,this.displaymoves()}},__log=function(e,s){console.log("["+e+"] "+s.join(" / "))},log=function(...e){__log("INFO",e)},debug=function(...e){__log("DEBUG",e)};function sleep(s){return new Promise(e=>setTimeout(e,s))}const readOneFile=function(e,s){e=e.target.files[0];if(e){log("Reading file "+e.name);const t=new FileReader;t.onload=function(e){e=e.target.result;s(e)},t.readAsText(e)}},parsePGNfile=(e,s=!0)=>{currentTree&&currentTree.board.destroy(),currentTree=new OpeningTree(e,s)},loadfromuri=($(document).on("change","#pgnupload",function(e){readOneFile(e,parsePGNfile),$("#pgnupload").value=null}),$("#pgndownloadlink").on("click",function(){var e=new Blob([currentTree.content],{type:"application/vnd.chess-pgn, application/x-chess-pgn"});saveAs(e,"openings.pgn")}),$("#pgnuploadlink").on("click",function(){$("#pgnupload").trigger("click")}),()=>{const e=new URLSearchParams(window.location.search);var s=e.get("content");s?(s=LZString.decompressFromEncodedURIComponent(s))&&parsePGNfile(s):parsePGNfile(DEFAULT,!1)});loadfromuri();